<script>
  const loginPage = document.getElementById("loginPage");
  const registerPage = document.getElementById("registerPage");
  const faucetPage = document.getElementById("faucetPage");

  const loginButton = document.getElementById("loginButton");
  const goToRegister = document.getElementById("goToRegister");
  const registerButton = document.getElementById("registerButton");
  const backToLogin = document.getElementById("backToLogin");
  const logoutButton = document.getElementById("logoutButton");

  const loginMessage = document.getElementById("loginMessage");
  const registerMessage = document.getElementById("registerMessage");

  const claimButton = document.getElementById('claimButton');
  const timerDisplay = document.getElementById('timer');
  const message = document.getElementById('message');

  let cooldown = 300;

  // Funciones de usuarios
  function getUsers() {
    return JSON.parse(localStorage.getItem("users") || "{}");
  }

  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }

  function getLoggedIn() {
    return localStorage.getItem("loggedIn");
  }

  function saveLoggedIn(email) {
    localStorage.setItem("loggedIn", email);
  }

  function logout() {
    localStorage.removeItem("loggedIn");
    faucetPage.classList.add("hidden");
    loginPage.classList.remove("hidden");
  }

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
  }

  // Cooldown por usuario
  function getCooldown(email) {
    const cooldowns = JSON.parse(localStorage.getItem("cooldowns") || "{}");
    return cooldowns[email] || 0;
  }

  function setCooldown(email, seconds) {
    const cooldowns = JSON.parse(localStorage.getItem("cooldowns") || "{}");
    cooldowns[email] = seconds;
    localStorage.setItem("cooldowns", JSON.stringify(cooldowns));
  }

  function startCooldown(email) {
    let remaining = getCooldown(email);
    claimButton.disabled = true;
    claimButton.classList.add("opacity-50", "cursor-not-allowed");

    const interval = setInterval(() => {
      remaining--;
      setCooldown(email, remaining);
      timerDisplay.textContent = formatTime(remaining);

      if (remaining <= 0) {
        clearInterval(interval);
        claimButton.disabled = false;
        claimButton.classList.remove("opacity-50", "cursor-not-allowed");
        setCooldown(email, 0);
        timerDisplay.textContent = formatTime(0);
      }
    }, 1000);
  }

  function showFaucet() {
    loginPage.classList.add("hidden");
    registerPage.classList.add("hidden");
    faucetPage.classList.remove("hidden");

    const email = getLoggedIn();
    const users = getUsers();
    const user = users[email];
    message.textContent = `Balance: ${user.balance} monedas`;

    // Mostrar cooldown si existe
    let userCooldown = getCooldown(email);
    if (userCooldown > 0) {
      claimButton.disabled = true;
      claimButton.classList.add("opacity-50", "cursor-not-allowed");
      timerDisplay.textContent = formatTime(userCooldown);
      startCooldown(email);
    } else {
      timerDisplay.textContent = formatTime(cooldown);
      claimButton.disabled = false;
      claimButton.classList.remove("opacity-50", "cursor-not-allowed");
    }
  }

  // Login
  function loginUser() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    const users = getUsers();

    if(users[email] && users[email].password === password) {
      saveLoggedIn(email);
      showFaucet();
    } else {
      loginMessage.textContent = "Correo o contraseña incorrectos.";
    }
  }

  // Registro con referido
  function registerUser() {
    const email = document.getElementById("registerEmail").value.trim();
    const password = document.getElementById("registerPassword").value.trim();
    const referidoEmail = document.getElementById("registerRef").value.trim();

    if (!email || !password) {
      registerMessage.textContent = "Completa los campos obligatorios.";
      return;
    }

    const users = getUsers();

    if (users[email]) {
      registerMessage.textContent = "Este correo ya está registrado.";
      return;
    }

    // Crear usuario
    users[email] = { password, balance: 0, referido: null };

    // Si existe referido válido, darle bonus
    if (referidoEmail && users[referidoEmail]) {
      users[email].referido = referidoEmail;
      users[referidoEmail].balance += 5; // bonus al referido
    }

    saveUsers(users);
    registerMessage.textContent = "Cuenta creada. Puedes volver a login.";
  }

  // Reclamar faucet
  claimButton.addEventListener('click', () => {
    const email = getLoggedIn();
    if (!email) return;

    const users = getUsers();
    users[email].balance += 10; // recompensa de ejemplo
    saveUsers(users);

    message.textContent = `¡Felicidades! Has reclamado 10 monedas. Balance: ${users[email].balance}`;
    setCooldown(email, cooldown);
    startCooldown(email);
  });

  // Navegación
  goToRegister.addEventListener("click", () => {
    loginPage.classList.add("hidden");
    registerPage.classList.remove("hidden");
    loginMessage.textContent = "";
  });

  backToLogin.addEventListener("click", () => {
    registerPage.classList.add("hidden");
    loginPage.classList.remove("hidden");
    registerMessage.textContent = "";
  });

  loginButton.addEventListener("click", loginUser);
  registerButton.addEventListener("click", registerUser);
  logoutButton.addEventListener("click", logout);

  // Mantener sesión
  if(getLoggedIn()) {
    showFaucet();
  }
</script>